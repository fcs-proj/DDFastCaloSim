name: Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  run:
    runs-on: ubuntu-24.04
    container:
      image: ghcr.io/key4hep/key4hep-images/alma9-cvmfs:latest
      options: >-
        --privileged
        --device=/dev/fuse
        --cap-add=SYS_ADMIN

    steps:
      # Checkout the repository
      - uses: actions/checkout@v4

      # Debug CVMFS configuration
      - name: Debug CVMFS Configuration
        run: cat /etc/cvmfs/default.local

      # Check FUSE module
      - name: Check FUSE Module
        run: lsmod | grep fuse || echo "FUSE module not loaded"

      # Ensure CVMFS Mount
      - name: Ensure CVMFS Mount
        run: |
          set -e
          cvmfs_config probe
          mount -t cvmfs sw.hsf.org /cvmfs/sw.hsf.org || echo "Failed to mount /cvmfs/sw.hsf.org"
          ls /cvmfs/sw.hsf.org || echo "CVMFS content not available"

      # Collect CVMFS Logs
      - name: Collect CVMFS Logs
        run: cat /var/log/cvmfs/* || echo "No CVMFS logs found"
